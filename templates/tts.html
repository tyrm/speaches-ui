{{define "tts-content"}}
<!-- Audio Player -->
<div id="playerContainer" class="player-container">
	<div class="player-controls">
		<button id="playBtn" class="play-btn">‚ñ∂ Play</button>
		<div class="progress-container">
			<input type="range" id="progressBar" class="progress-bar" min="0" value="0">
			<span id="timeDisplay" class="time-display">0:00 / 0:00</span>
		</div>
	</div>
</div>

<!-- Hidden Audio Element -->
<audio id="audioPlayer"></audio>

<!-- TTS Form -->
<form id="ttsForm">
	<div class="form-layout">
		<div class="form-left">
			<div class="form-group">
				<label for="paragraphInput">Enter text to speak:</label>
				<textarea
					class="form-control"
					id="paragraphInput"
					placeholder="Type your text here... (Shift+Enter to submit)"
					required></textarea>
			</div>
		</div>
		<div class="form-right">
			<div class="form-group">
				<label for="modelSelect">Select Model:</label>
				<select class="form-control" id="modelSelect">
					<option value="tts-1">Kokoro (Neural TTS)</option>
					<option value="tts-1-piper">Piper (Fast TTS)</option>
				</select>
			</div>
			<div class="form-group">
				<label for="voiceSelect">Select Voice:</label>
				<select class="form-control" id="voiceSelect">
					<!-- Voices populated dynamically -->
				</select>
			</div>
			<button type="button" class="btn btn-primary btn-speak" id="speakBtn">
				üîä Speak
			</button>
			<div id="statusMessage"></div>
			<div id="errorAlert" class="alert alert-danger" role="alert"></div>
			<div id="successAlert" class="alert alert-success" role="alert"></div>
		</div>
	</div>
</form>

<script>
	const speakBtn = document.getElementById('speakBtn');
	const textInput = document.getElementById('paragraphInput');
	const modelSelect = document.getElementById('modelSelect');
	const voiceSelect = document.getElementById('voiceSelect');
	const audioPlayer = document.getElementById('audioPlayer');
	const playerContainer = document.getElementById('playerContainer');
	const playBtn = document.getElementById('playBtn');
	const progressBar = document.getElementById('progressBar');
	const timeDisplay = document.getElementById('timeDisplay');
	const errorAlert = document.getElementById('errorAlert');
	const successAlert = document.getElementById('successAlert');
	const statusMessage = document.getElementById('statusMessage');

	let audioUrl = null;

	// Voice options for each model
	const voiceOptions = {
		'tts-1': {
			'American Female': [
				{ value: 'af_nova', label: 'Nova (Neutral)' },
				{ value: 'af_sarah', label: 'Sarah (Clear)' },
				{ value: 'af_bella', label: 'Bella (Warm)' },
				{ value: 'af_heart', label: 'Heart (Expressive)' },
				{ value: 'af_aoede', label: 'Aoede (Bright)' },
				{ value: 'af_jessica', label: 'Jessica (Smooth)' },
				{ value: 'af_kore', label: 'Kore (Dynamic)' },
				{ value: 'af_nicole', label: 'Nicole (Natural)' },
				{ value: 'af_river', label: 'River (Calm)' },
				{ value: 'af_sky', label: 'Sky (Gentle)' },
				{ value: 'af_alloy', label: 'Alloy (Balanced)' }
			],
			'American Male': [
				{ value: 'am_adam', label: 'Adam (Friendly)' },
				{ value: 'am_echo', label: 'Echo (Deep)' },
				{ value: 'am_liam', label: 'Liam (Professional)' },
				{ value: 'am_onyx', label: 'Onyx (Commanding)' },
				{ value: 'am_michael', label: 'Michael (Energetic)' },
				{ value: 'am_eric', label: 'Eric (Smooth)' },
				{ value: 'am_fenrir', label: 'Fenrir (Intense)' },
				{ value: 'am_puck', label: 'Puck (Playful)' },
				{ value: 'am_santa', label: 'Santa (Jolly)' },
				{ value: 'am_liam', label: 'Lewis (Rich)' }
			],
			'British Female': [
				{ value: 'bf_alice', label: 'Alice (Posh)' },
				{ value: 'bf_emma', label: 'Emma (Refined)' },
				{ value: 'bf_isabella', label: 'Isabella (Elegant)' },
				{ value: 'bf_lily', label: 'Lily (Sweet)' }
			],
			'British Male': [
				{ value: 'bm_fable', label: 'Fable (Theatrical)' },
				{ value: 'bm_george', label: 'George (Distinguished)' },
				{ value: 'bm_daniel', label: 'Daniel (Smooth)' },
				{ value: 'bm_lewis', label: 'Lewis (Rich)' }
			]
		},
		'tts-1-piper': {
			'Ryan (US Male)': [
				{ value: 'en_US-ryan-high', label: 'High Quality' },
				{ value: 'en_US-ryan-medium', label: 'Medium Quality' },
				{ value: 'en_US-ryan-low', label: 'Low Quality' }
			],
			'US Female Voices': [
				{ value: 'en_US-hfc_female-medium', label: 'HFC Female' },
				{ value: 'en_US-amy-medium', label: 'Amy Medium' },
				{ value: 'en_US-amy-low', label: 'Amy Low' },
				{ value: 'en_US-kathleen-low', label: 'Kathleen' },
				{ value: 'en_US-kristin-medium', label: 'Kristin' },
				{ value: 'en_US-ljspeech-high', label: 'LJ Speech High' },
				{ value: 'en_US-ljspeech-medium', label: 'LJ Speech Medium' }
			],
			'US Male Voices': [
				{ value: 'en_US-hfc_male-medium', label: 'HFC Male' },
				{ value: 'en_US-lessac-high', label: 'Lessac High' },
				{ value: 'en_US-lessac-medium', label: 'Lessac Medium' },
				{ value: 'en_US-lessac-low', label: 'Lessac Low' },
				{ value: 'en_US-danny-low', label: 'Danny' },
				{ value: 'en_US-joe-medium', label: 'Joe' },
				{ value: 'en_US-john-medium', label: 'John' },
				{ value: 'en_US-bryce-medium', label: 'Bryce' },
				{ value: 'en_US-kusal-medium', label: 'Kusal' },
				{ value: 'en_US-norman-medium', label: 'Norman' }
			],
			'British Voices': [
				{ value: 'en_GB-alan-medium', label: 'Alan Medium' },
				{ value: 'en_GB-alan-low', label: 'Alan Low' },
				{ value: 'en_GB-southern_english_female-low', label: 'Southern Female' },
				{ value: 'en_GB-alba-medium', label: 'Alba' },
				{ value: 'en_GB-aru-medium', label: 'Aru' },
				{ value: 'en_GB-cori-high', label: 'Cori High' },
				{ value: 'en_GB-cori-medium', label: 'Cori Medium' },
				{ value: 'en_GB-jenny_dioco-medium', label: 'Jenny Dioco' },
				{ value: 'en_GB-northern_english_male-medium', label: 'Northern Male' },
				{ value: 'en_GB-semaine-medium', label: 'Semaine' },
				{ value: 'en_GB-vctk-medium', label: 'VCTK' }
			]
		}
	};

	// Populate voice dropdown based on selected model
	function updateVoiceOptions() {
		const selectedModel = modelSelect.value;
		const voices = voiceOptions[selectedModel];
		const previousVoice = voiceSelect.value;

		voiceSelect.innerHTML = '';

		for (const [group, voiceList] of Object.entries(voices)) {
			const optgroup = document.createElement('optgroup');
			optgroup.label = group;

			voiceList.forEach(voice => {
				const option = document.createElement('option');
				option.value = voice.value;
				option.textContent = voice.label;
				optgroup.appendChild(option);
			});

			voiceSelect.appendChild(optgroup);
		}

		if (previousVoice && Array.from(voiceSelect.options).some(opt => opt.value === previousVoice)) {
			voiceSelect.value = previousVoice;
		}
	}

	// Load saved preferences from localStorage
	function loadPreferences() {
		const savedModel = localStorage.getItem('tts-model');
		const savedVoice = localStorage.getItem('tts-voice');

		if (savedModel) {
			modelSelect.value = savedModel;
		}

		return savedVoice;
	}

	// Save preferences
	function saveModelPreference() {
		localStorage.setItem('tts-model', modelSelect.value);
	}

	function saveVoicePreference() {
		localStorage.setItem('tts-voice', voiceSelect.value);
	}

	// Initialize
	const savedVoice = loadPreferences();
	updateVoiceOptions();

	if (savedVoice && Array.from(voiceSelect.options).some(opt => opt.value === savedVoice)) {
		voiceSelect.value = savedVoice;
	}

	modelSelect.addEventListener('change', function() {
		saveModelPreference();
		updateVoiceOptions();
	});

	voiceSelect.addEventListener('change', saveVoicePreference);

	// Handle speak button click
	speakBtn.addEventListener('click', async function() {
		const text = textInput.value.trim();

		if (!text) {
			showError('Please enter some text to speak');
			return;
		}

		speakBtn.disabled = true;
		speakBtn.textContent = 'üîä Speaking...';
		statusMessage.textContent = 'Generating speech...';
		hideAllAlerts();

		try {
			const response = await fetch('/api/tts', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					text: text,
					model: modelSelect.value,
					voice: voiceSelect.value
				})
			});

			if (!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.error || 'Failed to generate speech');
			}

			const audioBlob = await response.blob();
			if (audioUrl) {
				URL.revokeObjectURL(audioUrl);
			}
			audioUrl = URL.createObjectURL(audioBlob);

			audioPlayer.src = audioUrl;
			resetPlayer();
			audioPlayer.play();
			updatePlayButton();
			statusMessage.textContent = '';

		} catch (error) {
			console.error('TTS Error:', error);
			showError('Error: ' + error.message);
			statusMessage.textContent = '';
		} finally {
			speakBtn.disabled = false;
			speakBtn.textContent = 'üîä Speak';
		}
	});

	// Play/Pause handler
	playBtn.addEventListener('click', function() {
		if (audioPlayer.paused) {
			audioPlayer.play();
		} else {
			audioPlayer.pause();
		}
		updatePlayButton();
	});

	audioPlayer.addEventListener('play', updatePlayButton);
	audioPlayer.addEventListener('pause', updatePlayButton);

	function updatePlayButton() {
		if (audioPlayer.paused) {
			playBtn.textContent = '‚ñ∂ Play';
		} else {
			playBtn.textContent = '‚è∏ Pause';
		}
	}

	// Progress bar seeking
	progressBar.addEventListener('input', function() {
		if (audioPlayer.duration) {
			audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
		}
	});

	audioPlayer.addEventListener('timeupdate', function() {
		if (audioPlayer.duration) {
			progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
		}
		updateTimeDisplay();
	});

	audioPlayer.addEventListener('loadedmetadata', function() {
		progressBar.max = 100;
		updateTimeDisplay();
	});

	audioPlayer.addEventListener('ended', function() {
		resetPlayer();
	});

	function resetPlayer() {
		progressBar.value = 0;
		updatePlayButton();
		updateTimeDisplay();
	}

	function updateTimeDisplay() {
		const current = formatTime(audioPlayer.currentTime);
		const duration = formatTime(audioPlayer.duration);
		timeDisplay.textContent = current + ' / ' + duration;
	}

	function formatTime(seconds) {
		if (!seconds || isNaN(seconds)) return '0:00';
		const mins = Math.floor(seconds / 60);
		const secs = Math.floor(seconds % 60);
		return mins + ':' + secs.toString().padStart(2, '0');
	}

	function showError(message) {
		errorAlert.textContent = message;
		errorAlert.classList.add('show');
		successAlert.classList.remove('show');
	}

	function showSuccess(message) {
		successAlert.textContent = message;
		successAlert.classList.add('show');
		errorAlert.classList.remove('show');
	}

	function hideAllAlerts() {
		errorAlert.classList.remove('show');
		successAlert.classList.remove('show');
	}

	// Shift+Enter to submit
	textInput.addEventListener('keydown', function(e) {
		if (e.shiftKey && e.key === 'Enter') {
			e.preventDefault();
			speakBtn.click();
		}
	});
</script>
{{end}}
